<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>My Trips | One-Up Travel</title>

  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #0a0a0f;
      color: white;
      min-height: 100vh;
    }

    /* SUBTLE TEXTURE BACKGROUND */
    .gradient-bg {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: 
        radial-gradient(circle at 20% 30%, rgba(99, 102, 241, 0.08) 0%, transparent 50%),
        radial-gradient(circle at 80% 70%, rgba(139, 92, 246, 0.06) 0%, transparent 50%),
        #0a0a0f;
      z-index: -1;
    }

    /* HEADER */
    header {
      padding: 25px 50px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: rgba(10, 10, 15, 0.8);
      backdrop-filter: blur(20px);
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .logo {
      display: flex;
      align-items: center;
      text-decoration: none;
    }

    .logo img {
      height: 45px;
    }

    nav {
      display: flex;
      gap: 25px;
      align-items: center;
    }

    nav a {
      color: rgba(255, 255, 255, 0.8);
      text-decoration: none;
      font-weight: 500;
      transition: 0.3s;
    }

    nav a:hover {
      color: white;
    }

    .signout-btn {
      background: rgba(239, 68, 68, 0.2);
      border: 1px solid rgba(239, 68, 68, 0.5);
      color: white;
      padding: 10px 24px;
      border-radius: 10px;
      cursor: pointer;
      font-weight: 600;
      transition: 0.3s;
    }

    .signout-btn:hover {
      background: rgba(239, 68, 68, 0.3);
      transform: translateY(-2px);
    }

    /* MAIN CONTENT */
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 60px 30px;
    }

    .welcome-section {
      margin-bottom: 50px;
    }

    .welcome-section h1 {
      font-size: 48px;
      font-weight: 800;
      margin-bottom: 10px;
      background: linear-gradient(135deg, #ffffff 0%, #f093fb 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .welcome-section p {
      font-size: 18px;
      opacity: 0.8;
    }

    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 50px;
    }

    .stat-card {
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      padding: 25px;
      border-radius: 16px;
      text-align: center;
    }

    .stat-number {
      font-size: 36px;
      font-weight: 800;
      margin-bottom: 5px;
    }

    .stat-label {
      font-size: 14px;
      opacity: 0.7;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    /* TRIPS SECTION */
    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
    }

    .section-header h2 {
      font-size: 32px;
      font-weight: 700;
    }

    .plan-trip-btn {
      background: #6366f1;
      color: white;
      text-decoration: none;
      padding: 12px 28px;
      border-radius: 10px;
      font-weight: 600;
      transition: 0.3s;
      box-shadow: 0 2px 8px rgba(99, 102, 241, 0.2);
    }

    .plan-trip-btn:hover {
      background: #4f46e5;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
    }

    /* TRIP CARDS */
    .trips-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
      gap: 25px;
      margin-bottom: 50px;
    }

    .trip-card {
      background: rgba(255, 255, 255, 0.08);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.15);
      border-radius: 20px;
      padding: 25px;
      transition: all 0.3s;
      cursor: pointer;
    }

    .trip-card:hover {
      transform: translateY(-5px);
      background: rgba(255, 255, 255, 0.12);
      box-shadow: 0 15px 40px rgba(0, 0, 0, 0.3);
    }

    .trip-header {
      display: flex;
      justify-content: space-between;
      align-items: start;
      margin-bottom: 15px;
    }

    .trip-destination {
      font-size: 24px;
      font-weight: 700;
      margin-bottom: 5px;
    }

    .trip-dates {
      font-size: 14px;
      opacity: 0.7;
    }

    .trip-status {
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
    }

    .status-planning {
      background: rgba(102, 126, 234, 0.2);
      border: 1px solid rgba(102, 126, 234, 0.5);
      color: #667eea;
    }

    .status-booked {
      background: rgba(34, 197, 94, 0.2);
      border: 1px solid rgba(34, 197, 94, 0.5);
      color: #22c55e;
    }

    .status-completed {
      background: rgba(156, 163, 175, 0.2);
      border: 1px solid rgba(156, 163, 175, 0.5);
      color: #9ca3af;
    }

    .trip-details {
      margin: 20px 0;
      padding: 20px 0;
      border-top: 1px solid rgba(255, 255, 255, 0.1);
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .trip-detail-item {
      display: flex;
      justify-content: space-between;
      margin-bottom: 10px;
      font-size: 14px;
    }

    .trip-detail-label {
      opacity: 0.7;
    }

    .trip-detail-value {
      font-weight: 600;
    }

    .trip-cost {
      font-size: 28px;
      font-weight: 800;
      color: #4ade80;
      margin-bottom: 20px;
    }

    .trip-actions {
      display: flex;
      gap: 10px;
    }

    .action-btn {
      flex: 1;
      padding: 10px;
      border-radius: 8px;
      border: none;
      font-weight: 600;
      cursor: pointer;
      transition: 0.3s;
    }

    .btn-view {
      background: #6366f1;
      color: white;
    }

    .btn-view:hover {
      background: #4f46e5;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
    }

    .btn-delete {
      background: rgba(239, 68, 68, 0.2);
      border: 1px solid rgba(239, 68, 68, 0.5);
      color: white;
    }

    .btn-delete:hover {
      background: rgba(239, 68, 68, 0.3);
      transform: translateY(-2px);
    }

    /* LOADING STATE */
    .loading {
      text-align: center;
      padding: 60px 20px;
      font-size: 18px;
      opacity: 0.7;
    }

    .loading-spinner {
      display: inline-block;
      width: 40px;
      height: 40px;
      border: 4px solid rgba(255, 255, 255, 0.3);
      border-top-color: white;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 20px;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* EMPTY STATE */
    .empty-state {
      text-align: center;
      padding: 80px 20px;
    }

    .empty-icon {
      font-size: 64px;
      margin-bottom: 20px;
      opacity: 0.5;
    }

    .empty-state h3 {
      font-size: 24px;
      margin-bottom: 10px;
    }

    .empty-state p {
      opacity: 0.7;
      margin-bottom: 30px;
    }

    /* MOBILE RESPONSIVE */
    @media (max-width: 768px) {
      header {
        padding: 20px 25px;
      }

      .container {
        padding: 40px 20px;
      }

      .welcome-section h1 {
        font-size: 36px;
      }

      .trips-grid {
        grid-template-columns: 1fr;
      }

      .section-header {
        flex-direction: column;
        gap: 20px;
        align-items: start;
      }

      .plan-trip-btn {
        width: 100%;
        text-align: center;
      }
    }
  </style>
</head>

<body>
  <div class="gradient-bg"></div>

  <!-- HEADER -->
  <header>
    <a href="index.html" class="logo">
      <img src="logo.png" alt="One-Up Travel">
    </a>
    
    <nav>
      <a href="index.html">Home</a>
      <a href="dashboard.html">My Trips</a>
      <button class="signout-btn" onclick="handleSignOut()">Sign Out</button>
    </nav>
  </header>

  <!-- MAIN CONTENT -->
  <div class="container">
    
    <!-- WELCOME SECTION -->
    <div class="welcome-section">
      <h1>Welcome back, <span id="userName">Traveler</span>! üëã</h1>
      <p>Here are all your saved trips</p>
    </div>

    <!-- STATS -->
    <div class="stats">
      <div class="stat-card">
        <div class="stat-number" id="totalTrips">0</div>
        <div class="stat-label">Total Trips</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="upcomingTrips">0</div>
        <div class="stat-label">Upcoming</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="totalSpent">$0</div>
        <div class="stat-label">Total Budget</div>
      </div>
    </div>

    <!-- TRIPS SECTION -->
    <div class="section-header">
      <h2>Your Trips</h2>
      <a href="index.html" class="plan-trip-btn">‚ûï Plan New Trip</a>
    </div>

    <!-- LOADING STATE -->
    <div class="loading" id="loadingState">
      <div class="loading-spinner"></div>
      <p>Loading your trips...</p>
    </div>

    <!-- TRIPS GRID -->
    <div class="trips-grid" id="tripsGrid" style="display: none;">
      <!-- Trip cards will be inserted here by JavaScript -->
    </div>

    <!-- EMPTY STATE -->
    <div class="empty-state" id="emptyState" style="display: none;">
      <div class="empty-icon">‚úàÔ∏è</div>
      <h3>No trips yet</h3>
      <p>Start planning your first adventure!</p>
      <a href="index.html" class="plan-trip-btn">Plan Your First Trip</a>
    </div>

  </div>

  <!-- Firebase Integration -->
  <script type="module">
    import { auth, db, collection, query, where, orderBy, getDocs, doc, deleteDoc, onAuthStateChanged } from './firebase-config.js';

    // ========================================
    // CHECK IF USER IS LOGGED IN
    // ========================================
    onAuthStateChanged(auth, async (user) => {
      if (user) {
        console.log('‚úÖ User logged in:', user.email);
        
        // Update user name
        const userName = user.displayName || localStorage.getItem('userName') || 'Traveler';
        document.getElementById('userName').textContent = userName;
        
        // Load user's trips
        await loadUserTrips(user.uid);
        
      } else {
        console.log('‚ùå User not logged in');
        alert('Please sign in to view your trips');
        window.location.href = 'auth.html';
      }
    });

    // ========================================
    // LOAD USER'S TRIPS FROM FIREBASE
    // ========================================
    async function loadUserTrips(userId) {
      try {
        const loadingState = document.getElementById('loadingState');
        const tripsGrid = document.getElementById('tripsGrid');
        const emptyState = document.getElementById('emptyState');
        
        // Show loading
        loadingState.style.display = 'block';
        tripsGrid.style.display = 'none';
        emptyState.style.display = 'none';
        
        // Query trips for this user
        const tripsQuery = query(
          collection(db, 'trips'),
          where('userId', '==', userId),
          orderBy('createdAt', 'desc')
        );
        
        const querySnapshot = await getDocs(tripsQuery);
        
        // Hide loading
        loadingState.style.display = 'none';
        
        if (querySnapshot.empty) {
          // No trips - show empty state
          emptyState.style.display = 'block';
          return;
        }
        
        // Show trips grid
        tripsGrid.style.display = 'grid';
        tripsGrid.innerHTML = '';
        
        let totalTrips = 0;
        let upcomingTrips = 0;
        let totalSpent = 0;
        
        // Create trip cards
        querySnapshot.forEach((docSnapshot) => {
          const trip = docSnapshot.data();
          const tripId = docSnapshot.id;
          
          totalTrips++;
          totalSpent += trip.totalCost || 0;
          
          // Check if upcoming
          const startDate = new Date(trip.startDate);
          if (startDate > new Date()) {
            upcomingTrips++;
          }
          
          // Create trip card
          const card = createTripCard(trip, tripId);
          tripsGrid.appendChild(card);
        });
        
        // Update stats
        document.getElementById('totalTrips').textContent = totalTrips;
        document.getElementById('upcomingTrips').textContent = upcomingTrips;
        document.getElementById('totalSpent').textContent = '$' + totalSpent.toLocaleString();
        
        console.log(`‚úÖ Loaded ${totalTrips} trips`);
        
      } catch (error) {
        console.error('‚ùå Error loading trips:', error);
        document.getElementById('loadingState').innerHTML = `
          <p style="color: #ef4444;">Error loading trips. Please refresh the page.</p>
        `;
      }
    }

    // ========================================
    // CREATE TRIP CARD ELEMENT
    // ========================================
    function createTripCard(trip, tripId) {
      const card = document.createElement('div');
      card.className = 'trip-card';
      
      // Determine status
      const startDate = new Date(trip.startDate);
      const endDate = new Date(trip.endDate);
      const now = new Date();
      
      let status = 'planning';
      let statusClass = 'status-planning';
      
      if (now > endDate) {
        status = 'completed';
        statusClass = 'status-completed';
      } else if (trip.bookingProgress?.total) {
        status = 'booked';
        statusClass = 'status-booked';
      }
      
      // Format dates
      const formatDate = (dateStr) => {
        const date = new Date(dateStr);
        return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
      };
      
      card.innerHTML = `
        <div class="trip-header">
          <div>
            <div class="trip-destination">${trip.destination || 'Unknown Destination'}</div>
            <div class="trip-dates">${formatDate(trip.startDate)} - ${formatDate(trip.endDate)}</div>
          </div>
          <div class="trip-status ${statusClass}">${status}</div>
        </div>
        
        <div class="trip-details">
          <div class="trip-detail-item">
            <span class="trip-detail-label">Duration</span>
            <span class="trip-detail-value">${trip.duration || 'N/A'} days</span>
          </div>
          <div class="trip-detail-item">
            <span class="trip-detail-label">Flights</span>
            <span class="trip-detail-value">${trip.flights?.length || 0} options</span>
          </div>
          <div class="trip-detail-item">
            <span class="trip-detail-label">Hotels</span>
            <span class="trip-detail-value">${trip.accommodation?.length || 0} options</span>
          </div>
          <div class="trip-detail-item">
            <span class="trip-detail-label">Activities</span>
            <span class="trip-detail-value">${trip.activities?.length || 0} planned</span>
          </div>
        </div>
        
        <div class="trip-cost">$${(trip.totalCost || 0).toLocaleString()}</div>
        
        <div class="trip-actions">
          <button class="action-btn btn-view" onclick="viewTrip('${tripId}')">
            View Trip
          </button>
          <button class="action-btn btn-delete" onclick="deleteTrip('${tripId}', '${trip.destination}')">
            Delete
          </button>
        </div>
      `;
      
      return card;
    }

    // ========================================
    // VIEW TRIP DETAILS
    // ========================================
    window.viewTrip = function(tripId) {
      // Store trip ID and redirect to itinerary page
      localStorage.setItem('viewingTripId', tripId);
      window.location.href = 'itinerary.html';
    }

    // ========================================
    // DELETE TRIP
    // ========================================
    window.deleteTrip = async function(tripId, destination) {
      const confirmDelete = confirm(`Are you sure you want to delete your trip to ${destination}?\n\nThis cannot be undone.`);
      
      if (!confirmDelete) return;
      
      try {
        await deleteDoc(doc(db, 'trips', tripId));
        console.log('‚úÖ Trip deleted:', tripId);
        alert('Trip deleted successfully!');
        
        // Reload trips
        const user = auth.currentUser;
        if (user) {
          await loadUserTrips(user.uid);
        }
        
      } catch (error) {
        console.error('‚ùå Error deleting trip:', error);
        alert('Error deleting trip. Please try again.');
      }
    }
  </script>

  <!-- Auth Handler -->
  <script type="module" src="auth-handler.js"></script>

</body>
</html>
